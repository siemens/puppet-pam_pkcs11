# Contributing

This module has grown over time based on a range of contributions from
people using it. If you follow these contributing guidelines your patch
will likely make it into a release a little quicker.

1. Fork and clone the repo.

1. Run the [tests](#checks-and-tests). We only take pull requests with passing
   tests, and it's great to know that you have a clean slate.

1. Create a new feature branch.

1. Add a test for your change. Only refactoring and documentation
   changes require no new tests. If you are adding functionality
   or fixing a bug, please add a test.

1. Make the test pass.

1. Commit your changes, push the feature branch to your fork, and submit a pull request.

## Development environment

This project is managed with
[PDK](https://puppet.com/try-puppet/puppet-development-kit/) and based on the
[PDK template](https://github.com/puppetlabs/pdk-templates).

Many files in this repo are generated by PDK, based on the configuration in the
`.sync.yml` file. Changes to files generated by PDK should only go through
changes to the `.sync.yml` and then be updated via `pdk update`.

For your convenience the `pdk` is also installed by the `Gemfile` in this repo
and [bundler](http://bundler.io/). Once the bundler project is properly
configured and installed, it can be called via `bundler exec pdk`.

Bundler manages the development tools and library ruby dependencies via the
`Gemfile`, which is generated by the PDK in this project.

### Setting up ruby dependencies with bundler

[PDK](https://puppet.com/docs/pdk/latest) provides a couple of environment
variables to modify the versions of
[puppet](https://puppet.com/docs/puppet),
[facter](https://puppet.com/docs/puppet/latest/facter.html) and
[hiera](https://puppet.com/docs/puppet/latest/hiera.html), which can be set
before fetching all dependencies.

For example:

```bash
export PUPPET_GEM_VERSION="~> 7.17.0"
export FACTER_GEM_VERSION="~> 2.5.7"
export HIERA_GEM_VERSION="~> 3.9.0"
```

You might want to specify a project local directory to fetch all dependencies
into before installing all of them:

```bash
bundle config set --local path vendor/bundle
```

Installing the ruby dependencies is done by:

```bash
bundle install
```

Afterward, you have access to the PDK:

```bash
bundle exec pdk
```

And other tools like [rake](https://ruby.github.io/rake/), a Make-like program
implemented in Ruby, which gives convenient access to common development tasks:

```bash
bundle exec rake --tasks
```

## Checks and tests

### Syntax, and style static checks

After setting up the development environment, you have access to static code
and style checks. For instance, checking the puppet and ruby code can be done
like this:

```bash
bundle exec rake validate lint check rubocop
```

Additionally check the Markdown files with
[markdownlint](https://github.com/markdownlint/markdownlint):

```bash
bundle exec rake markdownlint
```

### Unit test

The unit tests are implemented in `spec/unit/` and can be called by
running:

```bash
bundle exec rake spec
```

For parallel execution of the unit tests run:

```bash
bundle exec rake parallel_spec
```

### Acceptance tests

The unit tests just check if the code runs and contains the required resource
definitions. In those tests, the code is not used to provision real systems.
For this [litmus](https://github.com/puppetlabs/puppet_litmus) is used.

Litmus fires up fresh containers or virtual machines, applies this puppet
module and then checks if it behaved as expected by running a series of tests
on it. Those tests are implemented in `spec/acceptance/`.

Litmus is normally run in a Github action on each pull request. But it is also
possible to run it on a local machine. The following examples use the Docker
provisioner to provision a Debian 11 system with Puppet 7. For other options
see the [litmus documentation](https://puppetlabs.github.io/litmus/) and
the list of [available images](https://github.com/puppetlabs/litmusimage).

First, a machine has to be provisioned. To use the docker provisioner, you need
to have [Docker installed](https://docs.docker.com/engine/install/) and
properly configured. If you have some issues doing that, you can also use the
Github action runners with a draft pull request.

```bash
bundle exec rake 'litmus:provision[docker,litmusimage/debian:11]'
```

Afterward, the puppet agent has to be installed:

```bash
bundle exec rake 'litmus:install_agent[puppet7-nightly]'
```

Then the module is installed on the provisioned system:

```bash
bundle exec rake 'litmus:install_module'
```

Then the acceptance test can be executed:

```bash
bundle exec rake 'litmus:acceptance:parallel'
```

And finally, the provisioned system can be removed:

```bash
bundle exec rake 'litmus:tear_down'
```
